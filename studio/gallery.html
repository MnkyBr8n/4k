<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gallery Manager - 4K Studio</title>
  <link rel="stylesheet" href="css/studio.css">
  <link rel="stylesheet" href="css/gallery.css">
</head>
<body>
  <div class="gallery-container">
    <!-- Header -->
    <div class="gallery-header">
      <div class="header-left">
        <a href="dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
        <h1 id="characterName">Gallery</h1>
      </div>
      <div class="header-right">
        <button onclick="window.location.href='image-uploader.html'" class="btn-primary">
          + Upload Images
        </button>
      </div>
    </div>

    <!-- Album Tabs -->
    <div class="album-tabs">
      <button class="album-tab active" data-album="digital" onclick="galleryManager.switchAlbum('digital')">
        üì± Digital
        <span class="tab-count" id="digitalCount">0</span>
      </button>
      <button class="album-tab" data-album="analog" onclick="galleryManager.switchAlbum('analog')">
        üì∑ Analog
        <span class="tab-count" id="analogCount">0</span>
      </button>
      <button class="album-tab" data-album="in-progress" onclick="galleryManager.switchAlbum('in-progress')">
        ‚è≥ In Progress
        <span class="tab-count" id="progressCount">0</span>
      </button>
    </div>

    <!-- Toolbar -->
    <div class="gallery-toolbar">
      <div class="toolbar-left">
        <button onclick="galleryManager.selectAll()" class="btn-secondary">Select All</button>
        <button onclick="galleryManager.deselectAll()" class="btn-secondary">Deselect All</button>
      </div>
      
      <div class="toolbar-right">
        <select id="sortSelect" onchange="galleryManager.sortImages(this.value)" class="toolbar-select">
          <option value="">Sort by...</option>
          <option value="date">Upload Date</option>
          <option value="name">File Name</option>
          <option value="size">File Size</option>
        </select>
        
        <select id="filterTags" class="toolbar-select">
          <option value="">Filter by tag...</option>
        </select>
      </div>
    </div>

    <!-- Batch Controls (hidden by default) -->
    <div class="batch-controls" id="batchControls" style="display: none;">
      <div class="batch-info">
        <strong><span id="selectedCount">0</span></strong> images selected
      </div>
      
      <div class="batch-actions">
        <select id="moveToAlbum" onchange="if(this.value) { galleryManager.batchMove(this.value); this.value=''; }" class="batch-select">
          <option value="">Move to...</option>
          <option value="digital">Digital</option>
          <option value="analog">Analog</option>
          <option value="in-progress">In Progress</option>
        </select>
        
        <button onclick="galleryManager.batchAddTags()" class="btn-secondary">
          + Add Tags
        </button>
        
        <button onclick="galleryManager.batchRemoveTags()" class="btn-secondary">
          - Remove Tags
        </button>
        
        <button onclick="galleryManager.downloadSelectedAsZip()" class="btn-secondary">
          ‚¨á Download ZIP
        </button>
        
        <button onclick="galleryManager.batchDelete()" class="btn-danger">
          üóëÔ∏è Delete
        </button>
      </div>
    </div>

    <!-- Gallery Grid -->
    <div class="gallery-grid" id="galleryGrid">
      <!-- Images will be populated by JavaScript -->
    </div>

    <!-- Stats Footer -->
    <div class="gallery-footer">
      <div class="stats">
        <span id="totalImages">0</span> images ‚Ä¢ 
        <span id="totalSize">0 MB</span> total
      </div>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer"></div>

  <script type="module">
    import { galleryManager } from './js/gallery-manager.js';
    import { loadCharacterImages, getStorageStats } from './js/image-manager.js';

    // Get character ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const characterId = urlParams.get('id');

    if (!characterId) {
      alert('No character selected');
      window.location.href = 'dashboard.html';
    }

    // Load character info
    function loadCharacterInfo() {
      const characters = JSON.parse(localStorage.getItem('4k_characters') || '{}');
      const character = characters[characterId];
      
      if (!character) {
        alert('Character not found');
        window.location.href = 'dashboard.html';
        return;
      }
      
      document.getElementById('characterName').textContent = `${character.name} - Gallery`;
      document.title = `${character.name} Gallery - 4K Studio`;
    }

    // Update album counts
    function updateAlbumCounts() {
      const allImages = loadCharacterImages(characterId);
      
      const digitalCount = allImages.filter(img => img.album === 'digital').length;
      const analogCount = allImages.filter(img => img.album === 'analog').length;
      const progressCount = allImages.filter(img => img.album === 'in-progress').length;
      
      document.getElementById('digitalCount').textContent = digitalCount;
      document.getElementById('analogCount').textContent = analogCount;
      document.getElementById('progressCount').textContent = progressCount;
    }

    // Update stats footer
    function updateStats() {
      const stats = getStorageStats();
      const characterStats = stats.byCharacter[characterId] || { count: 0, size: 0 };
      
      document.getElementById('totalImages').textContent = characterStats.count;
      document.getElementById('totalSize').textContent = (characterStats.size / 1024 / 1024).toFixed(2);
    }

    // Load tag filter options
    function loadTagFilters() {
      const allImages = loadCharacterImages(characterId);
      const tagSet = new Set();
      
      allImages.forEach(img => {
        if (img.tags) {
          img.tags.forEach(tag => tagSet.add(tag));
        }
      });
      
      const filterSelect = document.getElementById('filterTags');
      filterSelect.innerHTML = '<option value="">Filter by tag...</option>';
      
      Array.from(tagSet).sort().forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        filterSelect.appendChild(option);
      });
    }

    // Initialize
    loadCharacterInfo();
    galleryManager.initGallery(characterId, 'digital');
    updateAlbumCounts();
    updateStats();
    loadTagFilters();

    // Make galleryManager available globally
    window.galleryManager = galleryManager;
  </script>
</body>
</html>
