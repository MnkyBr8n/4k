<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Edit Character Â· 4K Studio</title>
  <link rel="stylesheet" href="css/studio.css">
</head>
<body>
<header>
  <div><strong>Edit Character</strong></div>
  <div class="actions">
    <a class="btn secondary" href="index.html">Back</a>
  </div>
</header>

<main class="main">
  <div class="card">
    <div class="row">
      <div style="flex:1;min-width:260px">
        <label>Name</label>
        <input id="name" type="text">

        <label>Role</label>
        <input id="role" type="text">

        <label>About (quick)</label>
        <textarea id="aboutQuick"></textarea>

        <label>Template</label>
        <select id="template">
          <option value="passport">Passport</option>
          <option value="storycard">Story Card</option>
          <option value="roblox">Roblox</option>
          <option value="fortnite">Fortnite</option>
          <option value="dandy">Dandy</option>
          <option value="classic">Classic</option>
        </select>

        <div class="row" style="margin-top:10px">
          <button id="save" class="ok">Save Info</button>
        </div>
      </div>

      <div style="flex:1;min-width:260px">
        <label>Add Image</label>
        <input id="file" type="file" accept="image/*" capture="environment">
        <div class="row">
          <select id="album">
            <option value="digital">Digital</option>
            <option value="analog">Analog</option>
            <option value="profile">Profile</option>
          </select>
          <button id="addImg">Add</button>
        </div>

        <h3 style="margin-top:14px">Images</h3>
        <table class="table" id="imgs">
          <thead><tr><th>Preview</th><th>Album</th><th>Carousel</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<script type="module">
import { getCharacter, upsertCharacter, addImage, removeImage, setCarousel } from './js/store.js';
import { fileToObjectURL } from './js/ui.js';

const params = new URLSearchParams(location.search);
const id = params.get('id');
let char = getCharacter(id);
if(!char){ alert('Character not found'); location.href='index.html'; }

const nameEl = document.getElementById('name');
const roleEl = document.getElementById('role');
const aboutQuickEl = document.getElementById('aboutQuick');
const templateEl = document.getElementById('template');
const albumEl = document.getElementById('album');
const fileEl = document.getElementById('file');
const imgsTBody = document.querySelector('#imgs tbody');

function load(){
  char = getCharacter(id);
  nameEl.value = char.name || "";
  roleEl.value = char.role || "";
  aboutQuickEl.value = char.aboutQuick || "";
  templateEl.value = char.template || "storycard";
  renderImages();
}
function renderImages(){
  const arr = char.images || [];
  imgsTBody.innerHTML = arr.map(i => `
    <tr>
      <td><img src="${i.src}" alt="" style="width:60px;height:60px;object-fit:cover;border-radius:8px"></td>
      <td>${i.album||""}</td>
      <td>
        <input type="checkbox" data-src="${i.src}" class="carouselToggle" ${i.carousel?'checked':''}>
      </td>
      <td>
        <button class="danger delBtn" data-src="${i.src}">Delete</button>
      </td>
    </tr>
  `).join('') || `<tr><td colspan="4"><span class="small">No images yet.</span></td></tr>`;
  document.querySelectorAll('.delBtn').forEach(b => b.onclick = () => { removeImage(id, b.dataset.src); load(); });
  document.querySelectorAll('.carouselToggle').forEach(cb => cb.onchange = (e) => { setCarousel(id, cb.dataset.src, e.target.checked); load(); });
}
document.getElementById('addImg').onclick = async () => {
  const f = fileEl.files?.[0];
  if(!f) return alert('Pick a file first.');
  const url = await fileToObjectURL(f);
  addImage(id, { src: url, album: albumEl.value, carousel: false });
  fileEl.value = "";
  load();
};
document.getElementById('save').onclick = () => {
  char.name = nameEl.value.trim();
  char.role = roleEl.value.trim();
  char.aboutQuick = aboutQuickEl.value.trim();
  char.template = templateEl.value;
  // keep primary portrait in sync if first image exists
  if (char.images?.length) {
    char.portrait = char.images[0].src;
    char.fullArt = char.images[0].src;
  }
  upsertCharacter(char);
  alert('Saved.');
};
load();
</script>
</body>
</html>