<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - 4K Studio</title>
  <link rel="stylesheet" href="css/studio.css">
  <style>
    .toast {
      position: fixed;
      top: 80px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 9999;
      display: none;
      animation: slideIn 0.3s ease;
    }

    .toast.show {
      display: block;
    }

    .toast.success {
      background: var(--ok);
      color: white;
    }

    .toast.error {
      background: var(--error);
      color: white;
    }

    .connection-status {
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 16px;
      display: none;
      align-items: center;
      gap: 12px;
    }

    .connection-status.show {
      display: flex;
    }

    .connection-status.connected {
      background: rgba(0, 212, 170, 0.2);
      border: 1px solid var(--ok);
      color: var(--ok);
    }

    .connection-status.error {
      background: rgba(255, 100, 117, 0.2);
      border: 1px solid var(--error);
      color: var(--error);
    }

    .connection-status.testing {
      background: rgba(255, 170, 0, 0.2);
      border: 1px solid var(--warn);
      color: var(--warn);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .status-dot.connected {
      background: var(--ok);
      box-shadow: 0 0 8px var(--ok);
    }

    .status-dot.error {
      background: var(--error);
      box-shadow: 0 0 8px var(--error);
    }

    .status-dot.testing {
      background: var(--warn);
      box-shadow: 0 0 8px var(--warn);
      animation: pulse 1s infinite;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Header -->
  <header>
    <div><strong>‚öôÔ∏è Settings</strong></div>
    <div class="actions">
      <a class="btn secondary" href="dashboard.html">Back to Dashboard</a>
    </div>
  </header>

  <main class="main">
    <!-- GitHub Configuration -->
    <div class="card">
      <h2>üîó GitHub Configuration</h2>
      <p class="small" style="margin-bottom: 20px;">
        Connect your GitHub repository to enable automatic syncing of characters and images.
      </p>

      <label>Personal Access Token</label>
      <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
      <div class="small" style="margin-top: 4px; margin-bottom: 16px;">
        Create at: <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--brand);">GitHub Settings ‚Üí Personal Access Tokens</a><br>
        Required scope: <strong>repo</strong> (Full control of repositories)
      </div>

      <label>GitHub Username / Owner</label>
      <input type="text" id="githubOwner" placeholder="your-username">
      <div class="small" style="margin-top: 4px; margin-bottom: 16px;">
        Your GitHub username (e.g., "octocat")
      </div>

      <label>Repository Name</label>
      <input type="text" id="githubRepo" placeholder="my-website">
      <div class="small" style="margin-top: 4px; margin-bottom: 16px;">
        Just the repo name, not the full URL (e.g., "4k-art")
      </div>

      <label>Branch</label>
      <input type="text" id="githubBranch" placeholder="main" value="main">
      <div class="small" style="margin-top: 4px; margin-bottom: 16px;">
        Usually "main" or "gh-pages"
      </div>

      <!-- Connection Status -->
      <div id="connectionStatus" class="connection-status">
        <div class="status-dot" id="statusDot"></div>
        <div id="statusText">Not configured</div>
      </div>

      <!-- Buttons -->
      <div class="row" style="margin-top: 20px;">
        <button id="testBtn" class="secondary">üîç Test Connection</button>
        <button id="saveBtn" class="ok">üíæ Save Configuration</button>
        <button id="clearBtn" class="error">üóëÔ∏è Clear All</button>
      </div>
    </div>

    <!-- Current Configuration Display -->
    <div class="card" style="margin-top: 20px;">
      <h2>üìä Current Configuration</h2>
      <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px;">
        <p class="small" style="margin-bottom: 8px;">
          <strong>Status:</strong> <span id="displayStatus" style="color: var(--warn);">Not configured</span>
        </p>
        <p class="small" style="margin-bottom: 8px;">
          <strong>Owner:</strong> <span id="displayOwner">-</span>
        </p>
        <p class="small" style="margin-bottom: 8px;">
          <strong>Repository:</strong> <span id="displayRepo">-</span>
        </p>
        <p class="small" style="margin-bottom: 8px;">
          <strong>Branch:</strong> <span id="displayBranch">-</span>
        </p>
        <p class="small" style="margin-bottom: 0;">
          <strong>Token:</strong> <span id="displayToken">Not set</span>
        </p>
      </div>
    </div>
  </main>
	
	<script src="js/github-sync-ui.js"></script>
  <script type="module">

    // Storage keys
    const KEYS = {
      token: '4k_github_token',
      owner: '4k_github_owner',
      repo: '4k_github_repo',
      branch: '4k_github_branch'
    };

    // Elements
    const tokenInput = document.getElementById('githubToken');
    const ownerInput = document.getElementById('githubOwner');
    const repoInput = document.getElementById('githubRepo');
    const branchInput = document.getElementById('githubBranch');
    const testBtn = document.getElementById('testBtn');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const toast = document.getElementById('toast');
    const connectionStatus = document.getElementById('connectionStatus');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');

    // Display elements
    const displayStatus = document.getElementById('displayStatus');
    const displayOwner = document.getElementById('displayOwner');
    const displayRepo = document.getElementById('displayRepo');
    const displayBranch = document.getElementById('displayBranch');
    const displayToken = document.getElementById('displayToken');

    // Show toast notification
    function showToast(message, type = 'success') {
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Show connection status
    function showStatus(message, type = 'connected') {
      connectionStatus.className = `connection-status ${type} show`;
      statusDot.className = `status-dot ${type}`;
      statusText.textContent = message;
    }

    // Decrypt token from base64
    function decryptToken(encoded) {
      if (!encoded) return '';
      try {
        const decoded = atob(encoded);
        // Check if it looks like a valid token
        if (decoded.startsWith('ghp_') || decoded.startsWith('github_pat_')) {
          return decoded;
        }
        // If not, maybe it was stored unencrypted
        return encoded;
      } catch (e) {
        // If decode fails, return as-is (might be unencrypted)
        return encoded;
      }
    }

    // Load saved configuration
    function loadConfig() {
      console.log('Loading GitHub configuration...');

      const encryptedToken = localStorage.getItem(KEYS.token) || '';
      const token = decryptToken(encryptedToken);
      const owner = localStorage.getItem(KEYS.owner) || '';
      const repo = localStorage.getItem(KEYS.repo) || '';
      const branch = localStorage.getItem(KEYS.branch) || 'main';

      tokenInput.value = token;
      ownerInput.value = owner;
      repoInput.value = repo;
      branchInput.value = branch;

      updateDisplay();

      if (token && owner && repo) {
        showStatus('‚úì Configuration loaded', 'connected');
        console.log('Configuration loaded successfully');
      }
    }

    // Update display section
    function updateDisplay() {
      const encryptedToken = localStorage.getItem(KEYS.token);
      const token = decryptToken(encryptedToken);
      const owner = localStorage.getItem(KEYS.owner);
      const repo = localStorage.getItem(KEYS.repo);
      const branch = localStorage.getItem(KEYS.branch);

      const isConfigured = token && owner && repo;

      displayStatus.textContent = isConfigured ? 'Configured ‚úì' : 'Not configured';
      displayStatus.style.color = isConfigured ? 'var(--ok)' : 'var(--warn)';
      displayOwner.textContent = owner || '-';
      displayRepo.textContent = repo || '-';
      displayBranch.textContent = branch || '-';
      displayToken.textContent = token ? `${token.substring(0, 10)}...` : 'Not set';
    }

    // Save configuration
    function saveConfig() {
      console.log('Saving GitHub configuration...');

      const token = tokenInput.value.trim();
      const owner = ownerInput.value.trim();
      const repo = repoInput.value.trim();
      const branch = branchInput.value.trim() || 'main';

      // Validation
      if (!token) {
        showToast('‚ùå Please enter a GitHub token', 'error');
        showStatus('Missing token', 'error');
        return;
      }

      if (!owner) {
        showToast('‚ùå Please enter GitHub owner/username', 'error');
        showStatus('Missing owner', 'error');
        return;
      }

      if (!repo) {
        showToast('‚ùå Please enter repository name', 'error');
        showStatus('Missing repository', 'error');
        return;
      }

      // Validate token format
      if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
        showToast('‚ö†Ô∏è Token should start with "ghp_"', 'error');
        showStatus('Invalid token format', 'error');
        return;
      }

      // Save to localStorage
      try {
        // Encrypt token with base64 to match github-sync-ui.js expectations
        const encryptedToken = btoa(token);
        localStorage.setItem(KEYS.token, encryptedToken);
        localStorage.setItem(KEYS.owner, owner);
        localStorage.setItem(KEYS.repo, repo);
        localStorage.setItem(KEYS.branch, branch);

        // Reinitialize githubSyncUI if it exists so it picks up the new token
        if (window.githubSyncUI) {
          window.githubSyncUI.loadToken();
        }

        console.log('Configuration saved to localStorage:', {
          token: token.substring(0, 10) + '...',
          owner,
          repo,
          branch
        });

        showToast('‚úì Configuration saved successfully!', 'success');
        showStatus('‚úì Configuration saved', 'connected');
        updateDisplay();
      } catch (error) {
        console.error('Error saving configuration:', error);
        showToast('‚ùå Error saving configuration', 'error');
        showStatus('Save failed: ' + error.message, 'error');
      }
    }

    // Test connection
    async function testConnection() {
      console.log('Testing GitHub connection...');

      const token = tokenInput.value.trim();
      const owner = ownerInput.value.trim();
      const repo = repoInput.value.trim();

      if (!token || !owner || !repo) {
        showToast('‚ùå Please fill in all fields first', 'error');
        showStatus('Missing configuration', 'error');
        return;
      }

      showStatus('Testing connection...', 'testing');
      testBtn.disabled = true;
      testBtn.textContent = '‚è≥ Testing...';

      try {
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          console.log('Connection successful:', data.full_name);
          showToast('‚úì Connection successful!', 'success');
          showStatus(`‚úì Connected to ${data.full_name}`, 'connected');
        } else {
          const error = await response.json();
          console.error('Connection failed:', error);
          
          if (response.status === 401) {
            showToast('‚ùå Invalid token or insufficient permissions', 'error');
            showStatus('Authentication failed', 'error');
          } else if (response.status === 404) {
            showToast('‚ùå Repository not found', 'error');
            showStatus('Repository not found', 'error');
          } else {
            showToast(`‚ùå Connection failed: ${error.message}`, 'error');
            showStatus('Connection failed', 'error');
          }
        }
      } catch (error) {
        console.error('Network error:', error);
        showToast('‚ùå Network error: ' + error.message, 'error');
        showStatus('Network error', 'error');
      } finally {
        testBtn.disabled = false;
        testBtn.textContent = 'üîç Test Connection';
      }
    }

    // Clear configuration
    function clearConfig() {
      if (!confirm('Are you sure you want to clear all GitHub configuration?')) {
        return;
      }

      console.log('Clearing GitHub configuration...');

      localStorage.removeItem(KEYS.token);
      localStorage.removeItem(KEYS.owner);
      localStorage.removeItem(KEYS.repo);
      localStorage.removeItem(KEYS.branch);

      tokenInput.value = '';
      ownerInput.value = '';
      repoInput.value = '';
      branchInput.value = 'main';

      updateDisplay();
      showToast('‚úì Configuration cleared', 'success');
      showStatus('Configuration cleared', 'error');
      
      console.log('Configuration cleared successfully');
    }

    // Event listeners
    saveBtn.addEventListener('click', saveConfig);
    testBtn.addEventListener('click', testConnection);
    clearBtn.addEventListener('click', clearConfig);

    // Load configuration on page load
    loadConfig();

    // Log for debugging
    console.log('Settings page loaded');
    console.log('localStorage keys:', Object.keys(localStorage).filter(k => k.startsWith('4k_github')));
  </script>
</body>
</html>
